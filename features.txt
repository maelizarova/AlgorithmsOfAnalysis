def visualize_clusters_with_titles(
    cluster_df,
    cluster_titles_df,
    title="Карта жалоб с названиями кластеров",
    save_path=None,
    show=True
):
    """Строит scatter-проекцию с подробным описанием кластеров при наведении."""
    required_cols = {"dim_1", "dim_2", "cluster"}
    missing = required_cols - set(cluster_df.columns)
    if missing:
        raise ValueError(f"В cluster_df отсутствуют столбцы: {missing}")

    title_cols = {"cluster", "title", "type", "product", "summary"}
    missing_titles = title_cols - set(cluster_titles_df.columns)
    if missing_titles:
        raise ValueError(f"В cluster_titles_df отсутствуют столбцы: {missing_titles}")

    df_plot = cluster_df.copy().reset_index(drop=True)
    df_plot['cluster'] = df_plot['cluster'].astype(str)

    title_info = cluster_titles_df.copy()
    title_info['cluster'] = title_info['cluster'].astype(str)
    title_info = title_info["cluster title type product summary".split()].fillna("—")

    df_plot = df_plot.merge(title_info, on='cluster', how='left', suffixes=('', '_title'))
    for col in ["title", "type", "product", "summary"]:
        df_plot[col] = df_plot[col].fillna("Нет данных")

    if 'hover_text' not in df_plot.columns:
        text_source = df_plot.get('original_text', df_plot.get('cleaned_text', ''))
        df_plot['hover_text'] = text_source.apply(wrap_text_for_hover)

    if 'silhouette_point' not in df_plot.columns:
        df_plot['silhouette_point'] = np.nan

    fig = px.scatter(
        df_plot,
        x='dim_1',
        y='dim_2',
        color='cluster',
        title=title,
        height=650,
        custom_data=['cluster', 'title', 'type', 'product', 'summary', 'silhouette_point', 'hover_text']
    )

    fig.update_traces(
        hovertemplate=(
            "Кластер: %{customdata[0]}<br>"
            "Название: %{customdata[1]}<br>"
            "Тип: %{customdata[2]}<br>"
            "Продукт: %{customdata[3]}<br>"
            "Описание: %{customdata[4]}<br>"
            "Silhouette: %{customdata[5]:.3f}<br>"
            "%{customdata[6]}<extra></extra>"
        )
    )

    fig.update_layout(
        legend_title_text='Кластер',
        hoverlabel=dict(
            bgcolor='white',
            font_color='black',
            bordercolor='rgba(0,0,0,0.4)',
            align='left'
        )
    )

    if save_path:
        fig.write_html(save_path, include_plotlyjs='inline')
        logging.info(f"Интерактивный график сохранён: {save_path}")

    if show:
        fig.show()

    return df_plot, fig

# === Визуализация кластеров с названиями из LLM ===
if 'cluster_map_df' not in globals() or 'cluster_titles_df' not in globals():
    raise ValueError("Не найдены cluster_map_df/cluster_titles_df. Сначала запустите предыдущие шаги.")

if 'OUTPUT_DIR' not in globals():
    OUTPUT_DIR = "embedding_results"

cluster_map_with_titles_df, cluster_titles_fig = visualize_clusters_with_titles(
    cluster_map_df,
    cluster_titles_df,
    title="UMAP + названия кластеров",
    save_path=os.path.join(OUTPUT_DIR, "cluster_map_with_titles.html"),
    show=False
)

cluster_titles_fig.show()
cluster_map_with_titles_df.head()
