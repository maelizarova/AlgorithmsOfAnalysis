# === Сбор финального датафрейма для выгрузки ===
required_source_cols = ["Описание претензии", "Тип", "Подтип", "Претензия по продукту"]

base_df = df[required_source_cols].copy().reset_index(drop=True)
base_df['id'] = base_df.index + 1

cluster_info = cluster_map_df[['id', 'cluster']].copy()
cluster_titles_short = cluster_titles_df[['cluster', 'title', 'type', 'product', 'summary']].copy()
cluster_titles_short = cluster_titles_short.rename(columns={
    'title': 'cluster_title',
    'type': 'cluster_type',
    'product': 'cluster_product',
    'summary': 'cluster_summary'
})

final_df = (
    cluster_info
    .merge(cluster_titles_short, on='cluster', how='left')
    .merge(base_df, on='id', how='left')
)

final_df = final_df.drop(columns=['id'])
final_df = final_df[
    [
        'cluster',
        'cluster_title',
        'cluster_type',
        'cluster_product',
        'cluster_summary',
        'Описание претензии',
        'Тип',
        'Подтип',
        'Претензия по продукту'
    ]
]

print(f"Финальный датафрейм сформирован: {len(final_df)} строк")
display(final_df.head())

