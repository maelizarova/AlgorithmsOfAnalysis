# === Визуализация с помощью datamapplot ===

def mask_numbers_in_text(text):
    """Заменяет все цифры на X для защиты персональных данных"""
    if not isinstance(text, str):
        text = str(text)
    return re.sub(r'\d', 'X', text)


def create_datamapplot_visualization(
    coords,
    cluster_labels,
    cluster_titles_df,
    meta_df,
    output_path=None,
    title="Карта кластеров жалоб"
):
    """
    Создает интерактивную визуализацию с помощью datamapplot.
    
    Parameters:
    -----------
    coords : np.ndarray
        2D координаты точек (UMAP проекция)
    cluster_labels : np.ndarray
        Метки кластеров для каждой точки
    cluster_titles_df : pd.DataFrame
        DataFrame с информацией о кластерах (cluster, title, type, product)
    meta_df : pd.DataFrame
        DataFrame с метаданными (original_text)
    output_path : str, optional
        Путь для сохранения HTML файла
    title : str
        Заголовок визуализации
    """
    
    # Подготовка данных
    df_viz = pd.DataFrame(coords, columns=['x', 'y'])
    df_viz['cluster'] = cluster_labels
    df_viz = pd.concat([df_viz, meta_df.reset_index(drop=True)], axis=1)
    
    # Добавление информации о кластерах
    cluster_info = cluster_titles_df[['cluster', 'title', 'type', 'product']].copy()
    cluster_info['cluster'] = cluster_info['cluster'].astype(str) if cluster_info['cluster'].dtype != str else cluster_info['cluster']
    df_viz['cluster'] = df_viz['cluster'].astype(str)
    df_viz = df_viz.merge(cluster_info, on='cluster', how='left')
    
    # Заполнение пропусков
    df_viz['title'] = df_viz['title'].fillna('Без названия')
    df_viz['type'] = df_viz['type'].fillna('N/A')
    df_viz['product'] = df_viz['product'].fillna('N/A')
    
    # Маскировка персональных данных в тексте жалоб
    df_viz['masked_text'] = df_viz['original_text'].apply(mask_numbers_in_text)
    
    # Формирование текста для hover
    hover_text = []
    for idx, row in df_viz.iterrows():
        hover_info = f"Название: {row['title']}\nТип: {row['type']}\nПродукт: {row['product']}\n\nТекст жалобы:\n{row['masked_text']}"
        hover_text.append(hover_info)
    
    # Создание интерактивной визуализации
    # Согласно документации: create_interactive_plot(data_map, *label_layers, hover_text=None, ...)
    plot = datamapplot.create_interactive_plot(
        coords,
        cluster_labels,
        hover_text=hover_text,
        title=title
    )
    
    # Сохранение, если указан путь
    if output_path:
        plot.save(output_path)
        print(f"Визуализация datamapplot сохранена: {output_path}")
    
    return plot


# Создание визуализации с datamapplot
if 'coords_2d' in globals() and 'cluster_labels' in globals() and 'cluster_titles_df' in globals():
    datamapplot_fig = create_datamapplot_visualization(
        coords_2d,
        cluster_labels,
        cluster_titles_df,
        meta_df,
        output_path=os.path.join(OUTPUT_DIR, "datamapplot_clusters.html"),
        title="Кластеризация банковских жалоб"
    )
    datamapplot_fig
else:
    print("Сначала выполните предыдущие шаги для создания кластеризации")
