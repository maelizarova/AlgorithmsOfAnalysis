# === Пример полного пайплайна: подбор k, кластеризация, визуализация ===

OUTPUT_DIR = "embedding_results"

# 1. Загружаем готовые эмбеддинги
X_raw, X_scaled, meta_df, scaler = prepare_embedding_matrix(OUTPUT_DIR)
print(f"Загружено {X_raw.shape[0]} эмбеддингов размерности {X_raw.shape[1]}")

# 2. Проекция UMAP в 2D (удобно и для визуализации, и для кластеризации)
coords_2d, umap_model = project_embeddings_umap(
    X_scaled,
    n_neighbors=40,
    min_dist=0.05,
    n_components=2,
    metric='cosine'
)
print("UMAP готов:", coords_2d.shape)

# 3. Перебор количества кластеров. Можно поменять диапазон k_values
k_values = range(5, 31, 5)
score_df = evaluate_k_values(coords_2d, k_values)
display(score_df.sort_values('silhouette', ascending=False))

best_k = int(score_df.loc[score_df['silhouette'].idxmax(), 'k']) if not score_df.empty else 5
print(f"Выбранное k: {best_k}")

# 4. Кластеризация (MiniBatchKMeans по UMAP координатам)
cluster_labels, cluster_model = cluster_embeddings(coords_2d, n_clusters=best_k)
print("Кластеризация завершена. Всего кластеров:", len(np.unique(cluster_labels)))

# 5. Визуализация и выгрузка таблицы с координатами
cluster_map_df = visualize_clusters(
    coords_2d,
    cluster_labels,
    meta_df=meta_df,
    title=f"UMAP + KMeans (k={best_k})"
)

cluster_map_df.head()
