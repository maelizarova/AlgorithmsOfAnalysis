def subset_embeddings_by_source_df(
    X_raw,
    X_scaled,
    meta_df,
    source_df_subset,
    id_column_source='embedding_id'
):
    """Принимает заранее отфильтрованный DataFrame из complaints.csv и возвращает соответствующие эмбеддинги."""
    if id_column_source not in source_df_subset.columns:
        raise ValueError(f"В source_df_subset нет столбца '{id_column_source}'. Добавьте его (df['embedding_id'] = df.index + 1).")
    if 'id' not in meta_df.columns:
        raise ValueError("В meta_df отсутствует столбец 'id' — проверьте prepare_embedding_matrix().")

    requested_ids = source_df_subset[id_column_source].dropna().astype(int).tolist()
    if not requested_ids:
        raise ValueError("В переданном DataFrame нет валидных embedding_id")

    id_to_index = pd.Series(meta_df.index, index=meta_df['id'])
    aligned_idx = id_to_index.reindex(requested_ids).dropna().astype(int)
    if aligned_idx.empty:
        raise ValueError("Ни один из embedding_id не найден в meta_df — проверьте соответствие данных")

    X_raw_f = X_raw[aligned_idx.to_numpy()]
    X_scaled_f = X_scaled[aligned_idx.to_numpy()]
    meta_filtered = meta_df.loc[aligned_idx.index].reset_index(drop=True)

    print(f"Выбрано {len(meta_filtered)} строк из {len(meta_df)} на основе исходного DataFrame")
    return X_raw_f, X_scaled_f, meta_filtered

# Пример:
# subset = df.query("Тип == 'Жалоба'")
# X_raw_f, X_scaled_f, meta_subset = subset_embeddings_by_source_df(X_raw, X_scaled, meta_df, subset)

