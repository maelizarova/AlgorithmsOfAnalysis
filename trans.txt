def add_plotly_figure(self, fig: go.Figure, title: Optional[str] = None, 
                         caption: Optional[str] = None, height: Optional[int] = None) -> 'Cell':
        """Добавить Plotly график."""
        # Улучшаем настройки графика для корректного отображения
        fig.update_layout(
            autosize=True,
            margin=dict(l=60, r=20, t=80, b=90),  # Увеличили нижний отступ для легенды
            legend=dict(
                orientation="h",  # Горизонтальная легенда
                yanchor="top",
                y=-0.25,  # Дальше от графика, больше места от подписи оси
                xanchor="center",
                x=0.5,
                bgcolor='rgba(255,255,255,0.9)',
                bordercolor='rgba(0,0,0,0.3)',
                borderwidth=1
            )
        )
        
        # Высота по умолчанию или заданная пользователем
        default_height = f"{height}px" if height else '450px'
        html_content = fig.to_html(
            full_html=False, 
            include_plotlyjs='inline', 
            div_id=None,
            default_height=default_height,
            config={
                'displayModeBar': True,
                'displaylogo': False,  # Убираем логотип Plotly
                'modeBarButtonsToRemove': ['pan2d', 'lasso2d', 'select2d'],  # Убираем лишние кнопки
                'responsive': True,
                'toImageButtonOptions': {
                    'format': 'png',
                    'filename': 'chart',
                    'height': 500,
                    'width': 700,
                    'scale': 1
                }
            }
        )
        section = Section('plotly', html_content, title, caption)
        self.sections.append(section)
        return self
