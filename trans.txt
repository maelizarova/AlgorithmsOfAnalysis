# Формирование промпта для LLM
def create_prompt(products_kb, categories_kb, complaint_text):
    """
    Создает промпт для классификации жалобы
    """
    
    # Собираем все возможные значения для строгой проверки
    available_products = [product['name'] for product in products_kb['products']]
    
    # Собираем структурированную информацию о категориях
    category_structure = ""
    for category in categories_kb['complaint_categories']:
        category_structure += f"\nТИП: {category['type']}\n"
        category_structure += f"Определение: {category.get('definition', '')}\n"
        category_structure += "ПОДТИПЫ:\n"
        for subtype in category['subtypes']:
            category_structure += f"- {subtype['subtype']}: {subtype.get('definition', '')}\n"
    
    prompt_template = """
# Роль
Ты — классификатор жалоб. Твоя задача — сопоставить жалобу с категориями из строго заданных справочников.

# СТРОГИЕ ПРАВИЛА:
- Используй ТОЛЬКО готовые категории из справочников ниже
- НЕ придумывай новые названия
- НЕ изменяй формулировки

# КАК ВЫБИРАТЬ КАТЕГОРИИ:

## 1. ВЫБОР ПРОДУКТА:
- Прочитай жалобу и определи, о каком банковском продукте идет речь
- Выбери ОДИН продукт из списка ниже
- Если продукт неясен - используй "НЕОПРЕДЕЛЕН"

## 2. ВЫБОР ТИПА И ПОДТИПА ЖАЛОБЫ:
- Сначала определи ОБЩУЮ КАТЕГОРИЮ проблемы (тип)
- Затем найди КОНКРЕТНУЮ ПРОБЛЕМУ в рамках этого типа (подтип)
- Читай определения типов и подтипов - они помогут выбрать правильную категорию
- Выбери ОДНУ пару тип->подтип

## 3. ЕСЛИ НЕТ ТОЧНОГО СООТВЕТСТВИЯ:
- Выбери наиболее близкую категорию ИЗ ДОСТУПНЫХ
- Не создавай новые категории

# ДОСТУПНЫЕ ПРОДУКТЫ (выбери ОДИН):
{available_products}

# СТРУКТУРА КАТЕГОРИЙ ЖАЛОБ:
{category_structure}

# ФОРМАТ ОТВЕТА (JSON):
{{
  "product": "выбранный_продукт_из_списка",
  "complaint_type": "выбранный_тип_из_структуры", 
  "complaint_subtype": "выбранный_подтип_из_структуры",
  "confidence": "высокая/средняя/низкая",
  "explanation": "краткое обоснование почему выбран именно этот тип и подтип"
}}

Жалоба: "{complaint_text}"

Ответ:
"""
    
    return prompt_template.format(
        available_products=", ".join(available_products),
        category_structure=category_structure,
        complaint_text=complaint_text
    )
