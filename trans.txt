import polars as pl

merged_df = pl.scan_parquet(PATH_TO_SAMPLE)

# Ленивое чтение данных
feats = [pl.scan_parquet(f) for f in feature_paths]
# Ленивый join
for feat_df in tqdm.tqdm(feats):
    feat_df_casted = feat_df.with_columns([
        pl.col('client_did').cast(merged_df.schema['client_did'])
    ])
    diff_cols = (
        feat_df_casted
        .group_by(PRIMARY_KEY)
        .agg(pl.all().n_unique())
        .select(
            pl.exclude(PRIMARY_KEY).gt(1).any()
        )
    )
    
    res = [
        col for col, has_diff in diff_cols.row(0)
        if has_diff
    ]
    feat_df_casted = feat_df_casted.drop(res)
    merged_df = merged_df.join(feat_df_casted, on=PRIMARY_KEY, how='left')
    merged_df = merged_df.unique()
    
