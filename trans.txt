import pandas as pd
import json

def create_comparison_dataframe(merged_results_file, original_df):
    """
    Создает датафрейм для сравнения классификации модели с исходными данными
    
    Parameters:
    - merged_results_file: путь к файлу с результатами классификации
    - original_df: исходный датафрейм с разметкой
    """
    
    # Загружаем результаты классификации модели
    with open(merged_results_file, 'r', encoding='utf-8') as f:
        classification_results = json.load(f)
    
    # Создаем датафрейм из результатов модели
    model_data = []
    for result in classification_results:
        classification = result.get('classification', {})
        model_data.append({
            'index': result['id'] - 1,  # преобразуем в индекс (начинается с 0)
            'модель_продукт': classification.get('product', 'НЕОПРЕДЕЛЕН'),
            'модель_тип_жалобы': classification.get('complaint_type', 'ДРУГОЕ'),
            'модель_подтип_жалобы': classification.get('complaint_subtype', 'ДРУГОЕ'),
            'модель_уверенность': classification.get('confidence', 'низкая'),
            'модель_обоснование': classification.get('explanation', ''),
            'исходный_текст_жалобы': result['original_text']
        })
    
    model_df = pd.DataFrame(model_data)
    model_df = model_df.set_index('index')
    
    # Создаем копию исходного датафрейма для сравнения
    comparison_df = original_df.copy()
    
    # Добавляем колонки с результатами модели
    comparison_df['модель_продукт'] = model_df['модель_продукт']
    comparison_df['модель_тип_жалобы'] = model_df['модель_тип_жалобы']
    comparison_df['модель_подтип_жалобы'] = model_df['модель_подтип_жалобы']
    comparison_df['модель_уверенность'] = model_df['модель_уверенность']
    comparison_df['модель_обоснование'] = model_df['модель_обоснование']
    comparison_df['исходный_текст_жалобы_модель'] = model_df['исходный_текст_жалобы']
    
    return comparison_df



# Пример использования
if __name__ == "__main__":
    # Загружаем исходный датафрейм
    # original_df = pd.read_csv('your_data.csv')  # ваш файл с исходной разметкой
    
    # Создаем датафрейм для сравнения
    comparison_df = create_comparison_dataframe(
        merged_results_file='classification_results/all_results_merged.json',
        original_df=original_df
    )
    
    # Сохраняем результат
    comparison_df.to_csv('comparison_results.csv', index=False, encoding='utf-8-sig')
    
