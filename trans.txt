import pandas as pd
from openpyxl import Workbook
from openpyxl.utils.dataframe import dataframe_to_rows

# Предположим, combined_df - ваш готовый DataFrame
# Пример структуры:
# combined_df = pd.DataFrame({
#     'Model': ['Model 1', 'Model 1', 'Model 2'],
#     'Dataset': ['Train', 'Test', 'Train'],
#     'R2': [0.85, 0.82, 0.88]
# })

# Создаем новый Excel-файл
wb = Workbook()
ws = wb.active

# 1. Записываем заголовки
headers = list(combined_df.columns)
ws.append(headers)

# 2. Записываем данные
for r in dataframe_to_rows(combined_df, index=False, header=False):
    ws.append(r)

# 3. Объединяем ячейки с одинаковыми моделями
current_model = None
start_row = 2  # Первая строка с данными (после заголовка)

for row in range(2, ws.max_row + 1):
    model_cell = ws[f'A{row}']  # Колонка 'Model'
    
    if model_cell.value != current_model:
        # Если нашли новую модель, объединяем предыдущую группу
        if current_model is not None and (row - 1) > start_row:
            ws.merge_cells(f'A{start_row}:A{row-1}')
        current_model = model_cell.value
        start_row = row

# Объединяем последнюю группу
if (ws.max_row) > start_row:
    ws.merge_cells(f'A{start_row}:A{ws.max_row}')

# 4. Форматирование (опционально)
for row in ws.iter_rows():
    for cell in row:
        cell.alignment = Alignment(horizontal='center', vertical='center')

# Сохраняем файл
wb.save('final_merged_report.xlsx')
