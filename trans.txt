# –û–±–Ω–æ–≤–ª—è—é —Ñ—É–Ω–∫—Ü–∏—é, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ (Rows) –≤ –º–µ—Ç—Ä–∏–∫–∏

def generate_regression_report(
    train: pd.DataFrame,
    test: pd.DataFrame,
    oot: pd.DataFrame,
    target: str,
    model,  # –æ–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å LightGBM
    model_name: str = "LightGBM",
    save_path: str = "regression_report.xlsx"
) -> pd.DataFrame:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç –æ–± –æ–±—É—á–µ–Ω–∏–∏ –º–æ–¥–µ–ª–∏ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Excel.
    –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ (Rows) –≤ –∫–∞–∂–¥—É—é –≤—ã–±–æ—Ä–∫—É.
    """
    # –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ–≤–∞—Ä—è —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
    metrics = {
        "Dataset": [],
        "Rows": [],
        "R2": [],
        "MAE": [],
        "MSE": [],
        "RMSE": [],
        "Null Values %": [],
        "Zero Values %": []
    }

    def calculate_metrics(df, name):
        y_true = df[target]
        y_pred = model.predict(df.drop(columns=[target]))

        metrics["Dataset"].append(name)
        metrics["Rows"].append(df.shape[0])
        metrics["R2"].append(r2_score(y_true, y_pred))
        metrics["MAE"].append(mean_absolute_error(y_true, y_pred))
        metrics["MSE"].append(mean_squared_error(y_true, y_pred))
        metrics["RMSE"].append(np.sqrt(mean_squared_error(y_true, y_pred)))
        metrics["Null Values %"].append(y_true.isna().mean() * 100)
        metrics["Zero Values %"].append((y_true == 0).mean() * 100)

        return y_true, y_pred

    # –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
    y_train, y_train_pred = calculate_metrics(train, "Train")
    y_test, y_test_pred = calculate_metrics(test, "Test")
    y_oot, y_oot_pred = calculate_metrics(oot, "OOT")

    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –º–µ—Ç—Ä–∏–∫
    metrics_df = pd.DataFrame(metrics)

    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –º–æ–¥–µ–ª–∏
    hyperparameters = pd.DataFrame.from_dict(model.get_params(), orient="index", columns=["Value"])

    # –°–æ–∑–¥–∞–Ω–∏–µ Excel —Ñ–∞–π–ª–∞
    with pd.ExcelWriter(save_path, engine="openpyxl") as writer:
        metrics_df.to_excel(writer, sheet_name="Metrics", index=False)
        hyperparameters.to_excel(writer, sheet_name="Hyperparameters")
    
    return metrics_df

# –§—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ –º–µ—Ç—Ä–∏–∫–∏. üôÇ
